<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryGrid Studio | Cinematic Consistency</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #050505;
            --card-bg: #0f0f0f;
            --panel-border: #1f1f1f;
            --accent: #0f9d58; /* Story Grid Verde */
            --accent-dim: rgba(15, 157, 88, 0.15);
            --text-main: #e5e5e5;
            --text-muted: #737373;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Componentes de UI */
        .dark-panel {
            background-color: var(--card-bg);
            border: 1px solid var(--panel-border);
            transition: border-color 0.2s ease;
        }
        .dark-panel:hover { border-color: #333; }

        .section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-title i { color: var(--accent); }

        /* Option Cards (Model Selectors) */
        .option-card {
            background-color: #0a0a0a;
            border: 1px solid var(--panel-border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-card:hover {
            transform: translateY(-2px);
            border-color: #444;
        }
        input[type="radio"]:checked + .option-card {
            border-color: var(--accent);
            background-color: var(--accent-dim);
            box-shadow: 0 0 0 1px var(--accent);
        }
        input[type="radio"]:checked + .option-card i { color: var(--accent); }

        /* Inputs */
        input[type="text"], textarea, select {
            background-color: #0a0a0a;
            border: 1px solid var(--panel-border);
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-dim);
        }

        /* Scene Inputs & Loading State */
        .scene-input-group { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .translating-indicator {
            display: none;
            font-size: 0.7rem;
            color: var(--accent);
            animation: pulse 1.5s infinite;
        }
        .is-translating + .translating-indicator { display: block; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Buttons */
        .btn-gold {
            background: var(--accent);
            color: black;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }
        .btn-gold:hover {
            background: #ffc107;
            box-shadow: 0 0 15px rgba(15, 157, 88, 0.4);
        }
        
        .btn-secondary {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ccc;
            transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: #666; color: white; }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: #111;
            border: 1px solid #333;
            width: 90%; max-width: 500px;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Progress Bar */
        #download-progress-container {
            width: 100%;
            height: 4px;
            background: #333;
            margin-top: 10px;
            border-radius: 2px;
            display: none;
        }
        #download-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.2s;
        }

        #toast {
            visibility: hidden;
            background-color: var(--accent);
            color: #000;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            padding: 12px 24px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-10">

    <!-- HEADER -->
    <header class="w-full border-b border-[#1f1f1f] bg-black/80 backdrop-blur-md z-20 px-6 py-4 flex justify-center sticky top-0">
        <div class="max-w-7xl w-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-3 h-8 bg-[#0f9d58] rounded-sm shadow-[0_0_15px_rgba(15,157,88,0.5)]"></div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">STORY GRID <span class="text-[#0f9d58] font-light">STUDIO</span></h1>
                    <p class="text-[10px] text-[#555] uppercase tracking-[0.2em]">Cinematic Consistency Engine</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <!-- AI Translator Toggle -->
                <div class="flex items-center gap-3 bg-[#0a0a0a] border border-[#333] px-3 py-1.5 rounded-full">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold text-gray-300">TRADUTOR IA</span>
                        <span class="text-[8px] text-[#0f9d58] uppercase tracking-wide">Beta (Local)</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="translator-toggle" onchange="toggleTranslator()">
                        <span class="slider"></span>
                    </label>
                </div>

                <button onclick="resetForm()" class="text-[10px] uppercase tracking-widest text-[#555] hover:text-red-500 transition flex items-center gap-2 border border-transparent hover:border-[#333] px-3 py-1 rounded">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
            </div>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8 px-6">
        
        <!-- LEFT COLUMN: CONTROLS -->
        <div class="lg:col-span-7 space-y-6">
            
            <!-- 1. AI Model Selection -->
            <div class="dark-panel p-5 rounded-lg">
                <div class="section-title">
                    <i class="fa-solid fa-microchip"></i> Motor de IA (Model)
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <label class="cursor-pointer relative">
                        <input type="radio" name="ai-model" value="chatgpt" class="peer sr-only" checked onchange="updatePreview()">
                        <div class="option-card p-4 rounded-lg flex flex-col items-center justify-center h-24 text-center">
                            <i class="fa-solid fa-robot text-xl mb-2 text-gray-500 transition-colors"></i>
                            <span class="text-xs font-semibold text-gray-300">ChatGPT / DALL-E</span>
                        </div>
                    </label>
                    <label class="cursor-pointer relative">
                        <input type="radio" name="ai-model" value="kling" class="peer sr-only" onchange="updatePreview()">
                        <div class="option-card p-4 rounded-lg flex flex-col items-center justify-center h-24 text-center">
                            <i class="fa-solid fa-clapperboard text-xl mb-2 text-gray-500 transition-colors"></i>
                            <span class="text-xs font-semibold text-gray-300">Kling AI</span>
                        </div>
                    </label>
                    <label class="cursor-pointer relative">
                        <input type="radio" name="ai-model" value="gemini" class="peer sr-only" onchange="updatePreview()">
                        <div class="option-card p-4 rounded-lg flex flex-col items-center justify-center h-24 text-center">
                            <i class="fa-solid fa-star text-xl mb-2 text-gray-500 transition-colors"></i>
                            <span class="text-xs font-semibold text-gray-300">Gemini / Imagen</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 2. Character & Style -->
            <div class="dark-panel p-5 rounded-lg">
                <div class="section-title">
                    <i class="fa-solid fa-fingerprint"></i> Identidade & Mundo
                </div>
                
                <div class="space-y-4">
                    <!-- Character -->
                    <div class="relative">
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 block flex items-center justify-between">
                            <span>Quem é o Personagem?</span>
                            <span class="translating-indicator" id="loader-character">TRADUZINDO... <i class="fa-solid fa-spinner fa-spin ml-1"></i></span>
                        </label>
                        <input type="text" id="character" 
                               placeholder="Ex: Uma jovem escrevendo numa máquina de escrever..." 
                               class="translatable-input w-full p-3 rounded text-sm placeholder-gray-700 font-mono text-[#0f9d58]" 
                               data-target="character">
                    </div>

                    <!-- Appearance -->
                    <div class="bg-[#1a1a1a]/50 p-3 rounded border border-dashed border-[#333] relative">
                        <label class="text-[10px] text-[#0f9d58] uppercase tracking-wider mb-2 block flex items-center justify-between">
                            <span><i class="fa-solid fa-lock mr-2"></i>Trajes & Aparência (CRUCIAL)</span>
                            <span class="translating-indicator" id="loader-appearance">TRADUZINDO... <i class="fa-solid fa-spinner fa-spin ml-1"></i></span>
                        </label>
                        <input type="text" id="appearance" 
                               placeholder="Ex: usando um suéter branco de lã, óculos redondos..." 
                               class="translatable-input w-full p-3 rounded text-sm placeholder-gray-700 bg-black border-[#333]" 
                               data-target="appearance">
                        <p class="text-[9px] text-gray-600 mt-2">Descreva roupas, cabelo e acessórios. A IA travará isso em todos os quadros.</p>
                    </div>

                    <!-- Setting -->
                    <div class="relative">
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 block flex items-center justify-between">
                             <span>Cenário / Ambiente</span>
                             <span class="translating-indicator" id="loader-setting">TRADUZINDO... <i class="fa-solid fa-spinner fa-spin ml-1"></i></span>
                        </label>
                        <input type="text" id="setting" 
                               placeholder="Ex: escritório vintage anos 70, estantes de madeira..." 
                               class="translatable-input w-full p-3 rounded text-sm placeholder-gray-700" 
                               data-target="setting">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 block">Estilo Visual</label>
                            <select id="style" class="w-full p-3 rounded text-xs text-gray-300" onchange="updatePreview()">
                                <option value="studio ghibli style, anime aesthetic, hand drawn">Anime / Studio Ghibli</option>
                                <option value="pixar style 3d render, 8k, detailed textures">Pixar / 3D Animation</option>
                                <option value="cinematic photography, photorealistic, 8k, dramatic lighting">Fotorealista / Filme</option>
                                <option value="comic book style, black and white inking, dynamic shading">HQs / Noir Comics</option>
                                <option value="cyberpunk aesthetic, neon lighting, futuristic">Cyberpunk / Sci-Fi</option>
                                <option value="oil painting, textured strokes, classical art">Pintura a Óleo</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 block">Formato (Aspect Ratio)</label>
                            <select id="ar" class="w-full p-3 rounded text-xs text-gray-300" onchange="updatePreview()">
                                <option value="cinema">Cinemático (16:9)</option>
                                <option value="wide">Horizontal (3:2)</option>
                                <option value="portrait">Vertical (2:3)</option>
                                <option value="square">Quadrado (1:1)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Storyboard Grid -->
            <div class="dark-panel p-5 rounded-lg border-l-4 border-l-[#0f9d58]">
                <div class="flex justify-between items-center mb-4">
                    <div class="section-title mb-0 text-[#0f9d58]">
                        <i class="fa-solid fa-film"></i> Sequência Narrativa (Grid)
                    </div>
                </div>

                <div id="scenes-container" class="space-y-3 mb-4">
                    <!-- Scenes injected via JS -->
                </div>

                <div class="flex gap-2 pt-2 border-t border-[#1f1f1f]">
                    <button onclick="addScene()" class="btn-secondary text-xs px-4 py-2 rounded flex items-center gap-2 hover:border-[#0f9d58] hover:text-[#0f9d58]">
                        <i class="fa-solid fa-plus"></i> Add Painel
                    </button>
                    <button onclick="removeScene()" id="btn-remove-scene" class="btn-secondary text-xs px-4 py-2 rounded flex items-center gap-2 hover:text-red-500 hover:border-red-900">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN: OUTPUT -->
        <div class="lg:col-span-5 space-y-6">
            <div class="sticky top-24">
                
                <!-- Output Box -->
                <div class="bg-[#0f0f0f] border border-[#1f1f1f] rounded-lg p-1 shadow-2xl relative overflow-hidden group">
                     <!-- Decorative Glow -->
                     <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-500/5 blur-[60px] rounded-full pointer-events-none"></div>

                    <div class="bg-[#0a0a0a] p-5 rounded-md relative z-10">
                        <div class="flex justify-between items-end mb-4">
                            <h2 class="text-[10px] font-bold text-[#0f9d58] uppercase tracking-wider border border-[#0f9d58]/30 px-2 py-1 rounded bg-[#0f9d58]/10">
                                Prompt Final (English)
                            </h2>
                            <span id="model-badge" class="text-[9px] uppercase tracking-widest text-gray-500">CHATGPT</span>
                        </div>

                        <div class="relative">
                            <textarea id="prompt-output" class="w-full h-[400px] bg-black/40 border border-[#262626] rounded p-4 text-xs text-gray-300 focus:border-[#0f9d58] focus:text-white font-mono resize-none leading-relaxed shadow-inner" readonly>Preencha os campos para gerar...</textarea>
                            
                            <!-- Copy Button Overlay -->
                            <button onclick="copyToClipboard()" class="absolute bottom-4 right-4 btn-gold px-4 py-2 rounded shadow-lg text-xs flex items-center gap-2 z-20">
                                <i class="fa-regular fa-copy"></i> Copiar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Panel for WebLLM -->
                <div id="webllm-status" class="hidden dark-panel p-4 rounded-lg bg-[#1a1a1a] border border-blue-900/30">
                     <h4 class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1 flex items-center gap-2">
                        <i class="fa-solid fa-server"></i> Status do Tradutor Local
                    </h4>
                    <p id="webllm-status-text" class="text-[10px] text-gray-400 font-mono">Inativo.</p>
                </div>

                <!-- Tips / Info Panel -->
                <div class="dark-panel p-4 rounded-lg bg-black/30">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-lightbulb text-[#0f9d58]"></i> Dicas para <span id="tips-model-name">...</span>
                    </h4>
                    <ul class="text-[11px] text-gray-500 space-y-2 pl-4 list-disc marker:text-[#333]" id="tips-list">
                        <!-- Tips JS -->
                    </ul>
                </div>

            </div>
        </div>
    </main>

    <!-- WARNING MODAL -->
    <div class="modal-overlay" id="warning-modal">
        <div class="modal-box">
            <div class="text-center mb-6">
                <i class="fa-solid fa-triangle-exclamation text-4xl text-[#0f9d58] mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-2">Download de Modelo IA</h3>
                <p class="text-sm text-gray-400 leading-relaxed">
                    Você está prestes a ativar o tradutor neural local. Isso fará o download de um modelo de IA (~2.5GB) diretamente para o cache do seu navegador.
                </p>
            </div>
            
            <div class="bg-[#1a1a1a] p-4 rounded border border-[#333] mb-6 text-left">
                <ul class="text-xs text-gray-300 space-y-2">
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-0.5"></i> <span>Privacidade total: seus dados nunca saem do PC.</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-hard-drive text-blue-500 mt-0.5"></i> <span>Requer ~2.5GB de espaço livre em disco.</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-microchip text-red-500 mt-0.5"></i> <span>Recomendado: Placa de vídeo (GPU) dedicada.</span></li>
                </ul>
            </div>

            <div id="download-progress-container">
                <div id="download-progress-bar"></div>
            </div>
            <p id="download-status-text" class="text-[10px] text-center text-gray-500 mt-2 mb-4 h-4"></p>

            <div class="flex gap-3 justify-center">
                <button onclick="cancelTranslator()" class="px-4 py-2 rounded text-sm text-gray-400 hover:text-white hover:bg-[#333] transition">Cancelar</button>
                <button onclick="confirmTranslator()" class="btn-gold px-6 py-2 rounded text-sm shadow-lg">Confirmar e Baixar</button>
            </div>
        </div>
    </div>

    <div id="toast">COPIADO COM SUCESSO!</div>

    <script>
        // --- STATE & CONFIG ---
        let sceneCount = 4;
        const maxScenes = 9;
        const minScenes = 1;
        let useTranslator = false;
        let translationCache = {}; // Stores { 'inputId': 'translatedText' }
        let debounceTimer;

        // --- DOM REFERENCES ---
        const scenesContainer = document.getElementById('scenes-container');
        const promptOutput = document.getElementById('prompt-output');
        const toast = document.getElementById('toast');
        const warningModal = document.getElementById('warning-modal');
        const progressBar = document.getElementById('download-progress-bar');
        const progressContainer = document.getElementById('download-progress-container');
        const statusText = document.getElementById('download-status-text');
        const toggleInput = document.getElementById('translator-toggle');
        const webllmStatusDiv = document.getElementById('webllm-status');
        const webllmStatusText = document.getElementById('webllm-status-text');
        
        // Added missing references for UI update
        const modelBadge = document.getElementById('model-badge');
        const tipsModelName = document.getElementById('tips-model-name');
        const tipsList = document.getElementById('tips-list');
        
        // Global for engine
        window.engine = null;
        window.isTranslatorReady = false;
        window.selectedModel = "Llama-3.2-3B-Instruct-q4f16_1-MLC"; 

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSceneInputs();
            updatePreview();
            setupInputListeners(); // Bind listeners to static inputs
        });

        // --- TRANSLATOR LOGIC ---

        function toggleTranslator() {
            if (toggleInput.checked) {
                // User wants to enable
                if (!window.isTranslatorReady) {
                    // First time: Show Warning
                    warningModal.classList.add('active');
                } else {
                    // Already loaded, just enable
                    useTranslator = true;
                    webllmStatusDiv.classList.remove('hidden');
                    updatePreview(); // Re-render with translations if available
                }
            } else {
                // Disable
                useTranslator = false;
                webllmStatusDiv.classList.add('hidden');
                updatePreview(); // Revert to raw inputs
            }
        }

        function cancelTranslator() {
            warningModal.classList.remove('active');
            toggleInput.checked = false;
        }

        async function confirmTranslator() {
            // UI Update
            progressContainer.style.display = 'block';
            statusText.innerText = "Inicializando engine...";
            const confirmBtn = document.querySelector('.modal-box .btn-gold');
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';

            try {
                // Check GPU
                if (!navigator.gpu) {
                    throw new Error("WebGPU não suportado neste navegador.");
                }

                // Dynamic Import to prevent crash on load
                // Using esm.run for better browser compatibility
                const webllm = await import("https://esm.run/@mlc-ai/web-llm");

                // Initialize Engine
                const initProgressCallback = (report) => {
                    const progress = report.progress * 100;
                    progressBar.style.width = `${progress}%`;
                    statusText.innerText = report.text;
                };

                window.engine = new webllm.MLCEngine();
                
                // Load Model
                await window.engine.reload(window.selectedModel, { 
                    initProgressCallback: initProgressCallback 
                });

                // Success
                window.isTranslatorReady = true;
                useTranslator = true;
                warningModal.classList.remove('active');
                webllmStatusDiv.classList.remove('hidden');
                webllmStatusText.innerText = "Modelo Carregado: Llama-3.2-3B (Pronto)";
                
                // Trigger translation for existing fields
                triggerBatchTranslation();

            } catch (err) {
                alert("Erro ao carregar IA: " + err.message);
                cancelTranslator();
            }
        }

        function setupInputListeners() {
            // Attach to static fields
            ['character', 'appearance', 'setting'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', (e) => handleInput(e.target));
            });
        }

        function handleInput(target) {
            // Always update preview immediately (shows raw text initially)
            updatePreview();

            // If translator is OFF, stop here
            if (!useTranslator || !window.isTranslatorReady) return;

            // Debounce translation
            const id = target.id;
            const text = target.value.trim();
            const loaderId = `loader-${id.split('-')[0]}`; // scene-1 -> loader-scene
            
            // Show loader if text exists
            const loader = document.getElementById(loaderId) || target.parentElement.querySelector('.translating-indicator');
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                if (text.length < 3) return;

                if (loader) loader.parentElement.classList.add('is-translating');
                
                try {
                    const translated = await runTranslation(text);
                    translationCache[id] = translated;
                    // Trigger preview update with new data
                    updatePreview(); 
                } catch (e) {
                    console.error("Translation failed", e);
                } finally {
                    if (loader) loader.parentElement.classList.remove('is-translating');
                }
            }, 1000); // Wait 1s after typing stops
        }

        async function runTranslation(text) {
            if (!window.engine) return text;

            // Simple prompting
            const messages = [
                { role: "system", content: "You are a translator. Translate the following Portuguese text to English. Output ONLY the English translation, nothing else." },
                { role: "user", content: text }
            ];

            const reply = await window.engine.chat.completions.create({
                messages,
                temperature: 0.1, // Low creative, high accuracy
                max_tokens: 256,
            });

            return reply.choices[0].message.content.trim();
        }

        async function triggerBatchTranslation() {
            // Translate everything currently in inputs
            const inputs = document.querySelectorAll('input[type="text"]');
            for (const input of inputs) {
                if (input.value) handleInput(input);
            }
        }

        // --- SCENE MANAGEMENT ---
        function renderSceneInputs() {
            scenesContainer.innerHTML = '';
            for (let i = 1; i <= sceneCount; i++) {
                const div = document.createElement('div');
                div.className = 'scene-input-group mb-3';
                div.innerHTML = `
                    <div class="relative">
                        <div class="flex justify-between mb-1">
                            <span class="text-[9px] text-gray-500 uppercase font-mono">Painel ${i}</span>
                            <span class="translating-indicator" id="loader-scene-${i}">TRADUZINDO... <i class="fa-solid fa-spinner fa-spin ml-1"></i></span>
                        </div>
                        <div class="flex gap-3 items-center">
                            <div class="w-6 h-6 rounded bg-[#1a1a1a] border border-[#333] text-gray-500 flex items-center justify-center text-[10px] font-mono flex-shrink-0">
                                ${i}
                            </div>
                            <input type="text" 
                                id="scene-${i}" 
                                placeholder="Descreva a cena em português..." 
                                class="scene-input w-full p-2.5 rounded text-xs bg-[#0a0a0a] border border-[#1f1f1f] focus:border-[#0f9d58] text-gray-300 placeholder-gray-700 transition-colors"
                                oninput="handleInput(this)">
                        </div>
                    </div>
                `;
                scenesContainer.appendChild(div);
            }
            updateButtonStates();
        }

        window.addScene = function() {
            if (sceneCount < maxScenes) {
                sceneCount++;
                renderSceneInputs();
                // Note: Re-rendering loses input values and cache references in this simple implementation. 
                // For a full app, we would sync state. For this demo, we accept clear on add.
            }
        }

        window.removeScene = function() {
            if (sceneCount > minScenes) {
                sceneCount--;
                renderSceneInputs();
            }
        }

        function updateButtonStates() {
            const btn = document.getElementById('btn-remove-scene');
            if (sceneCount <= minScenes) {
                btn.style.opacity = '0.3';
                btn.style.pointerEvents = 'none';
            } else {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }
        }

        // --- PROMPT LOGIC ---
        function getText(id) {
            const el = document.getElementById(id);
            if (!el) return "";
            const raw = el.value.trim();
            
            // If translator ON and we have a cached translation, use it
            if (useTranslator && translationCache[id]) {
                return translationCache[id];
            }
            return raw;
        }

        function updatePreview() {
            const model = document.querySelector('input[name="ai-model"]:checked').value;
            const style = document.getElementById('style').value;
            const arSelection = document.getElementById('ar').value;

            // Use the getter that checks for translation
            const char = getText('character') || "[CHARACTER]";
            const appearance = getText('appearance');
            const setting = getText('setting');
            
            // Combine character + appearance for consistency
            const fullCharDescription = appearance ? `${char} (${appearance})` : char;

            // Get scenes
            const inputs = document.querySelectorAll('.scene-input');
            let filledScenes = 0;
            const scenesArray = [];
            
            inputs.forEach((input, index) => {
                // Manually get ID since input variable is the element
                const id = input.id; 
                let val = input.value.trim();
                
                // Check translation
                if (useTranslator && translationCache[id]) {
                    val = translationCache[id];
                }

                if (val) {
                    scenesArray.push({ index: index + 1, text: val });
                    filledScenes++;
                } else {
                    scenesArray.push({ index: index + 1, text: `[SCENE ACTION ${index + 1}]` });
                }
            });

            // UI Updates
            updateUIForModel(model);

            let finalPrompt = "";

            if (model === 'kling') {
                // KLING AI FORMAT (Descriptive, Cinematic, No heavy params)
                let arText = "16:9 widescreen";
                if(arSelection === 'wide') arText = "3:2 standard";
                if(arSelection === 'portrait') arText = "2:3 vertical portrait";
                if(arSelection === 'square') arText = "1:1 square";

                finalPrompt = `High quality character sheet grid with ${sceneCount} distinct panels, ${arText} aspect ratio. `;
                finalPrompt += `Style: ${style}. `;
                finalPrompt += `Character: ${fullCharDescription}. `;
                if(setting) finalPrompt += `Setting: ${setting}. `;
                
                finalPrompt += `\n\nSequence details:\n`;
                scenesArray.forEach(s => {
                    finalPrompt += `- Panel ${s.index}: ${s.text}\n`;
                });
                
                finalPrompt += `\n\nEnsure consistent character details across all panels. High resolution, 8k, cinematic lighting, sharp focus.`;

            } else if (model === 'chatgpt') {
                // CHATGPT / DALL-E 3 FORMAT
                let arText = "wide horizontal";
                if(arSelection === 'cinema') arText = "widescreen cinematic (16:9)";
                if(arSelection === 'portrait') arText = "tall vertical";
                if(arSelection === 'square') arText = "square";

                finalPrompt = `Create a single ${arText} image divided into a ${sceneCount}-panel storyboard grid. `;
                finalPrompt += `Style: ${style}. `;
                finalPrompt += `Character: ${char}. `;
                if(appearance) finalPrompt += `Appearance details (MUST BE CONSISTENT): ${appearance}. `;
                if(setting) finalPrompt += `Setting: ${setting}. `;
                
                finalPrompt += `\n\nPanels:\n`;
                scenesArray.forEach(s => {
                    finalPrompt += `- Panel ${s.index}: ${s.text}\n`;
                });
                
                finalPrompt += `\nIMPORTANT: Ensure the character's features (specifically: ${appearance || "clothing and face"}) are identical in every panel. No text balloons.`;

            } else if (model === 'gemini') {
                // GEMINI / IMAGEN FORMAT
                let arText = "wide 3:2 aspect ratio";
                if(arSelection === 'cinema') arText = "cinematic 16:9 aspect ratio";
                if(arSelection === 'portrait') arText = "portrait 2:3 aspect ratio";
                if(arSelection === 'square') arText = "square 1:1 aspect ratio";

                finalPrompt = `Generate a character sheet grid with ${sceneCount} panels. `;
                finalPrompt += `Style: ${style}. Aspect Ratio: ${arText}. `;
                finalPrompt += `\nCharacter: ${char}.`;
                if(appearance) finalPrompt += `\nVisual Consistency details: ${appearance}.`;
                if(setting) finalPrompt += `\nSetting: ${setting}.`;
                
                finalPrompt += `\n\nSequence:\n`;
                scenesArray.forEach(s => {
                    finalPrompt += `Panel ${s.index}: ${s.text}. `;
                });
                
                finalPrompt += `\n\nEnsure strict character consistency. High detail 8k render.`;
            }

            // Display
            if (document.getElementById('character').value === "" && filledScenes === 0) {
                promptOutput.value = "Preencha os campos para gerar o prompt...";
                promptOutput.style.color = "#555";
            } else {
                promptOutput.value = finalPrompt;
                promptOutput.style.color = "#e5e5e5";
            }
        }

        function updateUIForModel(model) {
            let modelName = "Midjourney";
            let tips = [];

            if(model === 'kling') {
                modelName = "KLING AI (IMAGE)";
                tips = [
                    "Use o modo <b>'Text to Image'</b> no Kling.",
                    "A proporção (AR) deve ser ajustada na interface do Kling, mas o prompt ajuda.",
                    "Kling é excelente em realismo cinemático, aproveite o campo 'Estilo'."
                ];
            } else if(model === 'chatgpt') {
                modelName = "CHATGPT (DALL-E 3)";
                tips = [
                    "Descreva o 'Traje' detalhadamente.",
                    "DALL-E entende melhor frases completas em Inglês.",
                    "Evite termos de câmera muito técnicos, use descrições visuais."
                ];
            } else if(model === 'gemini') {
                modelName = "GEMINI / IMAGEN";
                tips = [
                    "Mantenha a descrição de 'Aparência' simples e direta.",
                    "Evite POVs muito complexos em painéis pequenos."
                ];
            }

            modelBadge.textContent = modelName;
            tipsModelName.textContent = modelName;
            tipsList.innerHTML = tips.map(t => `<li class="pl-1">${t}</li>`).join('');
        }

        // --- ACTIONS ---
        window.copyToClipboard = function() {
            const text = document.getElementById('prompt-output');
            text.select();
            text.setSelectionRange(0, 99999);
            document.execCommand("copy");
            
            const toast = document.getElementById('toast');
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        window.resetForm = function() {
            document.getElementById('character').value = '';
            document.getElementById('appearance').value = '';
            document.getElementById('setting').value = '';
            translationCache = {}; // Clear translation cache
            const inputs = document.querySelectorAll('.scene-input');
            inputs.forEach(i => i.value = '');
            updatePreview();
        }

    </script>
</body>
</html>
